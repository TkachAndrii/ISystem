version: "3.8"

services:
  mongo:
    image: mongo:7
    container_name: mongo
    restart: always
    ports:
      - "27017:27017"
    command: ["--bind_ip_all"]
    networks:
      - infosys-net
    volumes:
      # FIX 1: Using a named volume instead of a Windows path
      # This prevents the "WiredTiger" / "Connection Refused" errors on Windows
      - mongo_internal_data:/data/db
    healthcheck:
      # FIX 3: Healthcheck updated for no-auth (just pings the DB)
      test: ["CMD-SHELL", "mongosh --quiet --eval \"db.adminCommand({ ping: 1 })\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb-exporter:
    image: percona/mongodb_exporter:0.40.0
    container_name: mongodb-exporter
    restart: always
    ports:
      - "9216:9216"
    networks:
      - infosys-net
    depends_on:
      mongo:
        condition: service_healthy # FIX 2: Waits for Mongo to be ready
    command:
      - "--mongodb.uri=mongodb://mongo:27017"
      - "--collect-all"

  auth-service:
    build:
      context: ../src/auth_service
    container_name: auth_service
    volumes:
      - ../data/sqlite:/app/data
    ports:
      - "5000:5000"
    networks:
      - infosys-net

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./configs/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    networks:
      - infosys-net

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./configs/grafana/dashboards:/var/lib/grafana/dashboards
      - ./configs/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
    networks:
      - infosys-net

  crm-service:
    build:
      context: ../src/crm_service
      dockerfile: Dockerfile
    container_name: crm_service
    restart: always
    ports:
      - "5001:5001"
    networks:
      - infosys-net
    depends_on:
      auth-service:
        condition: service_started
      mongo:
        condition: service_healthy # FIX 2: Waits for Mongo to be ready
    environment:
      - MONGO_URI=mongodb://mongo:27017/crm_db

  db_stresser:
    build:
      context: ../src/db_stresser
    container_name: db_stresser
    depends_on:
      - auth-service
      - crm-service
    networks:
      - infosys-net
    environment:
      - AUTH_URL=http://auth_service:5000
      - CRM_URL=http://crm_service:5001
      - WORKERS=5
      - TARGET_OPS_PER_SEC=10
    restart: always

# VOLUMES DEFINITION
volumes:
  grafana_data:
  # This creates the hidden storage volume for MongoDB inside Docker
  mongo_internal_data:

networks:
  infosys-net:
    driver: bridge